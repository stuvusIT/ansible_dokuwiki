---
- name: Download latest dokuwiki
  get_url:
    url: https://download.dokuwiki.org/src/dokuwiki/dokuwiki-stable.tgz
    dest: /tmp/dokuwiki-stable.tgz
 
- name: Unarchive dokuwiki-stable.tgz to /srv/dokuwiki
  unarchive:
    src: /tmp/dokuwiki-stable.tgz
    dest: /tmp/dokuwiki
    owner: www-data
    remote_src: yes
    list_files: yes
  register: file_list

- name: Unarchive dokuwiki-stable.tgz to {{ dokuwiki_install_path }}
  unarchive:
    src: /tmp/dokuwiki
    dest: "{{ dokuwiki_install_path | dirname }}"
    owner: www-data
    remote_src: yes
    list_files: yes
  when: "{{ lookup('file', '/tmp/dokuwiki/VERSION')  != lookup('file', '{{ dokuwiki_install_path }}/VERSION') }}"

- name: Update php-xml package used by dokuwiki.
  apt:
    name: "{{ item }}"
    state: latest
    with_items:
        - php-xml
  when: ansible_pkg_mgr == "apt"

- name: Update php-ldap package used by dokuwiki.
  apt:
    name: "{{ item }}"
    state: latest
    with_items:
        - php-ldap
  when: ansible_pkg_mgr == "apt" and dokuwiki_authtype == "authldap"
